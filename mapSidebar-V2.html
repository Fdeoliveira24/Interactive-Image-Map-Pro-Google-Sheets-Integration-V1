<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* --- BASIC SIDEBAR STYLING --- */
      body {
        margin: 0;
        padding: 0;
        background: #000;
        font-family: Arial, sans-serif;
        color: #fff;
      }

      header {
        background-color: #1f1f1f;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
      }

      h2 {
        font-size: 15px;
        margin: 0;
      }

      button {
        background: #c12928;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
      }

      button:hover {
        background: #a92221;
      }

      iframe {
        width: 100%;
        height: 80vh; /* adjustable for taller map view */
        border: none;
      }

      #stats {
        background: #111;
        text-align: center;
        padding: 10px;
        font-size: 13px;
        line-height: 1.5;
      }

      .stat {
        display: inline-block;
        margin: 0 8px;
        font-weight: 600;
      }

      /* --- STATUS COLORS --- */
      .available { color: #75fb4c; }
      .reserved { color: #ffae42; }
      .sold { color: #ff4c4c; }
      .leased { color: #4c9aff; }
    </style>
  </head>

  <body>
    <!-- HEADER WITH REFRESH BUTTON -->
    <header>
      <h2>Storage Caves Live Map</h2>
      <button onclick="refreshMap()">↻ Refresh</button>
    </header>

    <!-- EMBEDDED INTERACTIVE MAP -->
    <iframe id="mapFrame" src="https://pxl360.com/interactive-map/storage-caves-v3.html"></iframe>

    <!-- LIVE STATUS STATS -->
    <div id="stats">
      <div class="stat available">Available: —</div>
      <div class="stat reserved">Reserved: —</div>
      <div class="stat sold">Sold: —</div>
      <div class="stat leased">Leased: —</div>
    </div>

    <script>
      /**
       * Reloads the map iframe and updates live stats.
       */
      function refreshMap() {
        const frame = document.getElementById('mapFrame');
        frame.src = frame.src; // reload map
        google.script.run.withSuccessHandler(updateStats).getUnitStats();
      }

      /**
       * Updates the stat labels dynamically with data from Sheet.
       */
      function updateStats(data) {
        document.querySelector('.available').textContent = `Available: ${data.available || 0}`;
        document.querySelector('.reserved').textContent = `Reserved: ${data.reserved || 0}`;
        document.querySelector('.sold').textContent = `Sold: ${data.sold || 0}`;
        document.querySelector('.leased').textContent = `Leased: ${data.leased || 0}`;
      }

      // Automatically load stats when sidebar first opens
      google.script.run.withSuccessHandler(updateStats).getUnitStats();
    </script>
  </body>
</html>